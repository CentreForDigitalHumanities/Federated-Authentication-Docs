<!DOCTYPE html> 
<html>
	<head>
		<title>How-to Saml</title>
	</head>
	<link rel="stylesheet" type="text/css" href="//npmcdn.com/bootstrap@4.0.0-alpha.5/dist/css/bootstrap.min.css"/>
	<link rel="stylesheet" type="text/css" href="lib/highlight/styles/default.css"/>

	<script
			  src="https://code.jquery.com/jquery-3.1.1.min.js"
			  integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
			  crossorigin="anonymous"></script>
	<script type="//npmcdn.com/tether@1.2.4/dist/js/utils.js"></script>
	<script src="//npmcdn.com/tether@1.2.4/dist/js/tether.min.js"></script>

	<script type="text/javascript" src="//npmcdn.com/bootstrap@4.0.0-alpha.5/dist/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="lib/highlight/highlight.pack.js"></script>
	<script type="text/javascript" src="lib/bootstrap-switch.js"></script>

	<script>
		hljs.initHighlightingOnLoad();
		$('document').ready(function(){
			
			$('#environmentSelector').bootstrapSwitch({
			    on: 'Production', // default 'On'
			    off: 'Acceptation', // default 'Off'
			    same: true, // default false. same text for on/off and onLabel/offLabel
			    size: 'sm', // xs/sm/md/lg, default 'md'
			    onClass: 'success', //success/primary/danger/warning/default, default 'primary'
			    offClass: 'success', //success/primary/danger/warning/default default 'default'
			});

			$('.nav-tabs a').click(function(event){
				$(this).tab('show');
				secondary = $(this).data('target-menu');
				$('#menu-tab-content .tab-pane.active').removeClass('active');
				$(secondary).tab('show'); 
			});

			environmentChanged();

		});

		function environmentChanged() {
			production = $('#environmentSelector').is(':checked');
			var namidpMetaProd = 'https://namidp.services.uu.nl/nidp/saml2/metadata';
			var namidpMetaAcc = 'https://anamidp.services.uu.nl/nidp/saml2/metadata'
			var logoutProd = 'http://logout.uu.nl';
			var logoutAcc = 'http://logout.acc.uu.nl';
			var generalIdpProd = 'namidp.services.uu.nl';
			var generalIdpAcc = 'anamidp.services.uu.nl';

			$namidpMeta = production ? namidpMetaProd : namidpMetaAcc;
			$logout = production ? logoutProd : logoutAcc;
			$general = production ? generalIdpProd : generalIdpAcc;

			$evn = production ? "On acceptation: " : "On production: ";
			$namIdpMetaTitle = $evn + (production ? namidpMetaAcc : namidpMetaProd);
			$logoutTitle = $evn + (production ? logoutAcc : logoutProd);
			$generalTitle = $evn + (production ? generalIdpAcc : generalIdpProd);

			$('.idp-base-link').html($general); $('.idp-base-link').prop("title", $generalTitle);
			$('.namidp-metadata-link').html($namidpMeta); $('.namidp-metadata-link').prop("title", $namIdpMetaTitle);
			$('.namidp-logout-link').html($logout); $('.namidp-logout-link').prop("title", $logoutTitle);
			$('a.namidp-metadata-active-link').html($namidpMeta); $('a.namidp-metadata-active-link').prop('href', $namidpMeta);

			addPopover('idp-base-link');
			addPopover('namidp-metadata-link');
			addPopover('namidp-logout-link');

			$('code').each(function(i, block){
				hljs.highlightBlock(block);
			});
		}

		function addPopover(el) {
			$('.' + el).prop('data-toggle', 'tooltip');
			$('.' + el).prop('data-placement', 'top');
			$('.' + el).tooltip();
		}
	</script>
	<body style="padding-top: 20px; padding-bottom: 50px; position: relative" data-spy="scroll" data-target="#scrollSpy">
		<div class="container">
			<div class="row">
				<div class="col-md-3 hidden-sm-down" id="scrollSpy" style="position: relative;">
					<div style="position: fixed;" class="tab-content" id="menu-tab-content">

						<!-- SimpleSamlPHP Menu -->
						<ul class="nav nav-list about-list hidden-phone hidden-tablet affix fixed tab-pane active" id="simplesaml-menu" role="tabpanel">
							<li><a href="#setup">Set-up SimpleSaml library</a></li>
							<li><a href="#examples">Using SimpleSaml in your Project</a>
								<ul>
									<li><a href="#req-auth">Require Authentication</a></li>
									<li><a href="#login">Login function</a></li>
									<li><a href="#Loginurl">Login URL</a></li>
									<li><a href="#logout">Loging out</a></li>
									<li><a href="#force auth">Force authentication</a></li>
								</ul>
							</li>
							<li><a href="#deviate">Deviate from the Single Sign-On</a></li>
						</ul>

						<!-- OneLogin menu -->
						<ul class="nav nav-list about-list hidden-phone hidden-tablet affix fixed tab-pane" 
							role="tabpanel" id="onelogin-python3-menu"
						>
							<li><a href="#setuppythonsaml">Set-up OneLogin Library</a></li>
							<li><a href="#onelogin-preparing-application">Preparing your project for OneLogin</a>
								<ul>
									<li><a href="#onelogin-auth-object">Setting up the auth object</a></li>
									<li><a href="#onelogin-metadata-page">Creating a metadata page</a></li>
								</ul>
							</li>
							<li><a href="#onelogin-contact-ITS">Contact ITS</a></li>
							<li><a href="#onelogin-use-in-project">Using OneLogin in your project</a>
								<ul>
									<li><a href="#onelogin-authenticate">Authenticate users in Python</a></li>
									<li><a href="#onelogin-process-response">Process the authentication response</a></li>
									<li><a href="#onelogin-check-auth-status">Checking authentication status</a></li>
									<li><a href="#python-logout">Logout</a></li>
								</ul>
							</li>
						</ul>

						<!-- Environment Switch -->
						<p>
						<br/>
						Environment:<br/>
						<input type="checkbox" id="environmentSelector" checked="checked" onchange="environmentChanged();"/>
						</p>

					</div>
				</div>
				<div class="col-md-9 col-sm-12">
						<h1 id="how-to-saml">how-to Saml</h1>
						<small style="padding-bottom: 100px; display: block; position: relative;">
							<div class="col-md-6 col-sm-12">
							Documentation written by <a href="http://uilots-labs.wp.hum.uu.nl/people/#AJM" target="_blank">A.J. de Mooij</a>.<br/>
							Lab Technician and Software Developar at <a href="https://uilots-labs.wp.hum.uu.nl/" target="_blank">Utrecht Institute of Linguistics OTS</a> (UiL OTS)<br/> 
							<a href="https://www.uu.nl/" target="_blank">Utrecht University</a>
							</div>
							<div class="col-md-6 col-sm-12">
							Special thanks to <a href="https://www.uu.nl/medewerkers/TPRdeHaas" target="_blank">T.P.R. de Haas</a>.<br/>Information and Technology Services.<br/><a href="https://www.uu.nl/" target="_blank">Utrecht University</a>
							</div>
						</small>
						<div class="row">
						<div class="col-xs 12 col-md-7">
						<p>This document tries to aggregate various how-to's in the topic of setting op SAML to talk to the Identity Provider of University Utrecht's ITS, and subsequently setting up a project to make use of the features offered by SAML.</p>
						<p>SAML (Security Assertion Markup Language) is an xml-based standard for allowing federated authentication. The Univerity Utrecht is slowly moving all its web applications from LDAP authentication to SAML. With SAML, the user is redirected to a login page of the university, so no passwords have to be sent over the server that hosts an application, while still allowing Solis-ID authentication.</p>
						<p>SAML consists of two parts: The Identity Provider (IdP) and the Service Provider (SP). The Identity Provider is hosted by the university. The Service Provider rests with the application, and communicates with the Identity Provider.</p>
						<p>This how-to tries to describe how to set up a SAML Service Provider to communicate with the universities Identity Provider using various libraries in various programming languages. You are welcome to contribute guides for other libraries or programming languages, such as
							<a href="https://github.com/onelogin/python-saml" target="_blank">Python</a>,
							<a href="https://github.com/onelogin/java-saml" target="_blank">Java</a>,
							<a href="https://github.com/onelogin/ruby-saml" target="_blank">Ruby</a>,
							<a href="https://github.com/onelogin/wordpress-saml" target="_blank">Wordpress</a>, etc
							).</p>

						<p>In the left menu you can select the production or acceptation environment for this how-to (<a href="#environmentCollapse" data-toggle="collapse" aria-expaned="false">read more</a>)</p>
						</div>
						<div class="col-xs-12 col-md-5">
							<div class="card">
								<div class="card-block">
								<h4 class="card-title">Join the cause!</h4>
								<p class="card-text">This how-to currently only describes implementing SAML into your application using the PHP Library SimpleSaml PHP. For many other programming languages, implementations exist as well. For example, <a href="https://github.com/onelogin/" target="_blank">OneLogin</a> provides such libraries for many languages.</p>
								<p class="card-text">The aim of this repository is to give guidance in implementing SAML into an application of <i>any</i> language. Did this how-to help you, but did you end up using a library not yet documented in this how-to, or do you want to suggest improvements?</p><p><strong>Then please help us</strong> by cloning <a href="https://github.com/UiL-OTS-labs-backoffice/SimpleSAML-Example-And-Documentation" target="_blank">this repository</a>, creating minimal code examples for the used programming language or updating the how-to and create a pull request.
								</div>
							</div>
						</div>
						</div>
						<div class="collapse" id="environmentCollapse">
							<div class="card">
								<div class="card-block">
									<p>ITS provides two environments. The production environment contains all Solis-IDs available for employees and students of Utrecht University and is more strict in how it can be used. For development and acceptation, an acceptation invironment is available. This environment is slightly less strict, which works well for development, but does not contain default Solis-ID's. Instead, you have to work with test accounts, which ITS can create for you.</p>
									<p>In the side menu, you can choose to read this how-to for production or for acceptation. The required URLS are automatically adapted for the environment you chose. Except for in the code boxes, howevering a url will show the value for the other environment, if it differs from the selected environment.</p>
									<p>In the code examples which you can find in the repository, the acceptation environment is always used. To test the examples for production, you will have to adapt the code to production.</p>
								</div>
							</div>
						</div>

						<ul class="nav nav-tabs">
							<li class="nav-item">
								<a class="nav-link active" data-toggle="tab" href="#simplesaml" data-target="#simplesaml" data-target-menu="#simplesaml-menu">
									SimpleSamlPHP
								</a>
							</li>
							<li class="nav-item">
								<a class="nav-link" data-toggle="tab" href="#onelogin-python3" data-target="#onelogin-python3" 
									data-target-menu="#onelogin-python3-menu">
									OneLogin Python3
								</a>
							</li>
						</ul>

						<div class="tab-content" id="HowToContent">
							<div id="simplesaml" class="tab-pane simple-saml-php external-content active" role="tabpanel">
								<h2 id="setup" class="how-to-title">Set-up SimpleSaml library</h2>
						<p>ITS requires all service providers to send its authentication requests over SSL. This means SimpleSaml can only be used with servers that serve the web application over secure HTTP (HTTPS).</p>
						<p>The instructions in this chapter follow the <a href="https://simplesamlphp.org/docs/stable/simplesamlphp-install" target="_blank">SimpleSaml tutorial</a>, but are finetuned on how to work with the Identity Provider served by ITS.</p>
						<p>In this tutorial, the name <var>hostname</var> will be used for the base URL of the web application. The name <var>saml_location</var> will be used for the absolute path saml is installed in. The name <var>saml_url</var> will be used for the url path to the saml service provider (as <var>host/saml_url</var>). The name <var>deploy_directory</var> will be used to refer to a private location on your server, where deployment files are placed. A bash script is provided in the file <var>deploy_saml.sh</var> in this repository, which will take away some of the heavy load.</p>
						<ol>
							<li><p>Download the latest SimpleSaml release from <a href="https://simplesamlphp.org/download" target="_blank">https://simplesamlphp.org/download</a> to <var>deploy_dir</var> on your server.</p></li>
							<li><p>Make sure all PHP packages mentioned in <a href="https://simplesamlphp.org/docs/stable/simplesamlphp-install" target="_blank">section 3 of the SimpleSaml docs</a> are installed. Most of these are standard.</p></li>
							<li><p>Copy the bash script from <var>deploy_saml.sh</var> to your <var>deploy_dir</var>, or be prepared to perform the actions in the script manually once this how-to indicates to run the script. In the script:</p>
								<ol>
									<li><p>Replace the value of <var>SAMLVersion</var> with the version number of the downloaded .tar.gz file. The file should be called <var>simplesamlphp-&lt;version&gt;.tar.gz</var>. If this is not the case, the script will fail.</p></li>
									<li><p>Replace the value of <var>SAMLLocation</var> with the absolute path <var>saml_location</var>. This should be an absolute path to a directory that is not accessible from the web. On default ICT&amp;M servers, this should probably be <i>/hum/web/<var>hostname/</var></i> or <i>/hum/web/<var>hostname</var>/private/</i>. <strong>Make sure to end with a forward slash, or the directory will be overwritten.</strong></p></li>
									<li><p>Replace the value of <var>SAMLPubLocation</var> with an absolute path to where a simlink can be created, such that <var>host/saml_url</var> opens this directory in the browser. On default ICT&amp;M servers, this will most likely be <i>/hum/web/<var>hostname</var>/htdocs/<var>saml_url</var></i></p></li>
								</ol>
							</li>
							<li><p>Connect a private and public key to SAML. You can use existing keys if they follow the X.509 standard (e.g. your SSL certificate), or you can generate a new private and public key. Make sure to call them <i>saml.pem</i> and <i>saml.crt</i> respectively. If you whish to generate your own keys, you can use the following command:</p>
							<pre><code class="bash">$ openssl req -newkey rsa:2048 -new -x509 -days 3652 -nodes -out saml.crt -keyout saml.pem</code></pre>
							<p>Fill out the information that this command asks for as fits your application.</p></li>
							<li><p>From the file <i>simplesaml-<var>&lt;version&gt;</var>.tar.gz</i>, copy the directories <i>config</i> and <i>metadata</i> without changing anything to <var>deploy_directory</var>.</p><p>The following minimal changes need to be made, but further configuration is possible. For most purposes, the changes below will suffice, however.</p>
							<ul>
								<li><strong>config/config.php</strong>
								<ol>
								<li><p>Change the value of <strong>baseurlpath</strong> to <var>host/saml_url/</var> (make sure to end with a forward slash)</p></li>
								<li><p>Change <strong>debug</strong> and <strong>showerrors</strong> to <var>false</var>.</p></li>
								<li><p>Change the value of <strong>auth.adminpassword</strong> to a new password. This is the password used for the admin login on the SimpleSaml Service Provider, so make sure to pick a safe password.</p>
								<li><p>Set <strong>admin.protectedindexpage</strong> and <strong>admin.protectedmetadata</strong> to <var>true</var></p></li>
								<li><p>Change the value of <strong>secretsalt</strong> to a new string of any length. The best practice for generating such a salt is using the following command:</p>
								<pre><code class="bash">$ tr -c -d '0123456789abcdefghijklmnopqrstuvwxyz' &lt; /dev/urandom | dd bs=32 count=1 2&gt; /dev/null;echo</code></pre><p>If this command complains about <i>illegal byte sequence</i>, first run</p>
								<pre><code class="bash">$ export LC_CTYPE=C</code></pre></li>
								<li><p>Change the value of <strong>technicalcontact_email</strong> to an e-mail address the technical administrator can receive e-mails on. This e-mailaddress is used by SimpleSaml to send error reports and this e-mail address will be public.</p></li>
								<li><p>Change <strong>session.cookie.secure</strong> and <strong>session.phpsession.httponly</strong> to <var>true</var>. Optionally, update <strong>session.cookie.path</strong>, <strong>session.cookie.domain</strong> and <strong>session.cookie.lifetime</strong> as explained in the comments above those fields.</p></li>
								<li><p>Add <i>"<span class="idp-base-link">namidp.services.uu.nl</span>"</i> and <var>host</var> (stripped of any https or path specifications) to the <strong>trusted.url.domains</strong> array. Add other domains you wish to redirect to after a login or logout request as well.</p></li>
								</ol>
								</li>
								<li><strong>config/authsources.php</strong>
								<ol>
								<li>
									<p>(Optional) Change the array key that is named <var>'default-sp'</var> to a name you want your Service Provider to have.</p>
									<p><a href="#changeSpnameWarning" data-toggle="collapse" aria-expaned="false">Warning! Not without consequence</a></p>
									<div class="collapse" id="changeSpnameWarning">
									<p>
									SimpleSAML php, like many other SAML providers, automatically generate a so called <i>Entity ID</i> based on the name of your service provider you define here. You can change this value without any problem as long as you have not yet sent your meta data to ITS. However, the Identity Provider of ITS expects the Entity ID to be that which is set in your meta data, as it uses this value to verify the identity of the Service Provider sending an authentication request. If you wish to change this value <i>after</i> the meta data of your Service Provider has been added to the Identity Provider that is hosted by ITS, make sure the Entity ID does <i>not</i> change.</p>
									<p>You can find the generated Entity ID in the meta data that you sent to ITS. Check the meta data (see steps 7 and 8 how to find your meta data) for the key <var>entityID</var>. This key will most likely have a value of the form <var>host/saml_url/module.php/saml/sp/metadata.php/default-sp</var> where <var>default-sp</var> is what you previously named your Service Provider.</p>
									<p>In the configuration array of the Service Provider, change the value of <var>entityID</var> from <var>null</var> to this value. Now this entityID is sent to the ITS Identity Provider regardless of the name of your Service Provider and no problems should occur when you change it</p>
									</div>
								</li>
								<li><p>In the array with the (former) key <var>'default-sp'</var>, add two key-value pairs:</p>
								<pre><code class="PHP">'privatekey' => 'saml.pem',
'certificate' => 'saml.crt'</code></pre><p>These keys refer to the private and public keys that were generated earlier.</li>
								<li><p>Change the value of <strong>idp</strong> to <i>"<span class="namidp-metadata-link">https://namidp.services.uu.nl/nidp/saml2/metadata</span>"</i></p></li>
								</ol>
								<p>Example minimal contents configuration:</p>
								<pre><code class="PHP">$config = array(

  // This is a authentication source which handles admin authentication.
  'admin' => array(
    // The default is to use core:AdminPassword, but it can be replaced with
    // any authentication source.

    'core:AdminPassword',
  ),


  // An authentication source which can authenticate against both SAML 2.0
  // and Shibboleth 1.3 IdPs.
  'default-sp' => array(
    'saml:SP',
    'privatekey' => 'saml.pem',
    'certificate' => 'saml.crt',

    // The entity ID of this SP.
    // Can be NULL/unset, in which case an entity ID is generated based on the metadata URL.
    'entityID' => null,

    // The entity ID of the IdP this should SP should contact.
    // Can be NULL/unset, in which case the user will be shown a list of available IdPs.
    'idp' => '<span class="namidp-metadata-link">https://namidp.services.uu.nl/nidp/saml2/metadata</span>',

    // The URL to the discovery service.
    // Can be NULL/unset, in which case a builtin discovery service will be used.
    'discoURL' => null
  )
);</code></pre>
								</li>
							</ul>
							</li>
							<li><p>Run the bash <var>deploy_saml.sh</var> script from the <var>deploy_dir</var>. This will put all the files in the correct locations.</p></li>
							<li><p>Open your browser and go to <var>host/saml_url</var> and login with username <var>admin</var> and the password you set in <var>config/config.php</var>.</p></li>
							<li><p>Click the <var>configuration</var> tab and check if all required parts of the PHP installation are running. Click the <var>sanity check</var> link, to see if the basic setup is configured correctly.</p></li>
							<li><p>Go to the <var>federation</var> tab and click <var>Show Metadata</var>. If no errors are shown, click the <var>get the metadata xml on a dedicated URL</var> link. This will download a meta data XML file.</p>
							<p>Send this file to ITS along with the message that you want to register your application with their Identity Provider. Give the base URL of your application and say if you want to make use of their acceptation or production Identity Provider (depending on what URL you entered in the <var>config/authsources.php</var> file). Also indicate which fields you want the Identity Provider to pass back with a successful authentication redirect (such as solis-ID, full name, e-mail address, etc).</p></li>
							<li><p>Wait for a reply</p></li>
							<li><p>If ITS accepts the request, they will add your Service Provider to their Identity Provider and send you back a file called <var>saml20-idp-remote.php</var>.</p>
							<p>Place this file in the <var>metadata</var> directory inside your <var>deploy_dir</var> and rerun the bash script <var>deploy_saml.sh</var> from your <var>deploy_dir</var>.</p>
							<p>This file is unique for the Identity Provider you register your service provider with and so does not change when you set op another service provider on another server. Once you have this file, you can use it on other servers as well, as long as you want to connect to the same Identity Provider on those servers (notice that the acceptation and production versions of the Identity Provider are two distinct Identity Providers, so switching between those requires switching between these files). You will, however, still need to contact ITS, as they will have to add your Service Provider to their Identity Provider.</p></li>
							<li><p>Go to <var>host/saml_url</var> and click the page <var>authentication</var>. Click <var>test configured authentication sources</var>. This should redirect you to the UU login page.</p><p>Enter your Solis-ID and password (or test account credentials if you are on the acception Identity Provider and your own Solis-ID has not been added) and click <var>login</var>.</p><p>If all works well, you are set up to implement SimpleSaml into your web application. If you see an error, the debugging begins, which this how-to cannot provide more than <a href="#debug_saml_collapse"  data-toggle="collapse" aria-expaned="false">the most general pointers for</a>. 

							<div class="collapse" id="debug_saml_collapse">
							<p>Debugging is made easiest by enabling debugging in your <var>config.php</var>. For full debugging, change the <var>config.php</var> to the following values:</p>
							<pre><code class="php">'debug' => true
'showerrors' => true,
'errorreporting' => true,
'debug.validatexml' => true,
'logging.level' => SimpleSAML_Logger::DEBUG,
'logging.handler' => 'syslog'
							</code></pre>
							<p>Now check the syslog with <pre><code class="bash">$ sudo tail -f /var/log/syslog</code></pre> (or whatever other location your syslog is, or whatever log you set in <var>logging.handler</var>).</p>
							<p>Make sure to disable debugging in production.</p>
							<p>If authentication already fails with the Identity Provider (e.g. with an <i>untrusted source</i> message), you are most likely to have made a mistake in the configuration of the Service Provider, or your Service Provider is not yet registered with the Identity Provider.</p>
							</div>
							</li>
						</ol>

						<h2 id="examples">Using SimpleSaml in your PHP Project</h2>
						<p>Once the library is installed, SimpleSaml is relatively easy to load into your project. The following paragraphs describe how to use functionality from SimpleSaml in a PHP project. These functions are also documented in <a href="//simplesamlphp.org/docs/1.8/simplesamlphp-sp-api" target="_blank">the SimpleSaml docs</a></p>

						<p>A few files with example code are provided in the <a href="https://github.com/UiL-OTS-labs-backoffice/SimpleSAML-Example-And-Documentation" target="_blank">Github repository</a>. These can be used by you if the instructions in the previous chapter have been completed and you have cloned this repository to your server. Edit the <var>conf.json</var> file and change the value of <var>saml_location</var> to the absolute base path of the SAML installation on your server.</p>

						<p>First, you have to load the library into your project, and then you have to create a SimpleSaml authentication object for your service provider. In this example, it is assumed the service provider is called <var>default-sp</var>. This depends on how you defined your service provider in <var>simplesaml/config/authsources.php</var>.</p>
						<pre><code class="PHP">// Load SimpleSaml library
require_once($samlloc . "lib/_autoload.php");

// Get service provider
$as = new SimpleSAML_Auth_Simple('default-sp');

// Only get attributes if user is authenticated
if($as->isAuthenticated()) {
  $attributes = $as->getAttributes();
}</code></pre>
						<h3 id="req-auth">Require Authentication</h3>
						<p>In most usecases ITS envisions, a website is only accessible for logged in users. In this scenario, a user who visits the website, but is not logged in at any of the other applications using the same Identity Provider, get redirected to the UU Login page. After authenticating with their Solis-ID, the user gets redirected back to the original page. As long as a user is logged in on any of the applications using the same Identity Provider, they do not have to reauthenticate again. This is called Single Sign-On (SSO).</p>
						<p>Enabling Saml authentication on a website where no access is allowed to unauthenticated users is very simple. On all pages where access is denied to unauthenticated users, simply add the line</p>
						<pre><code class="PHP">$as->requireAuth();</code></pre>

						<p>This function can take two arguments:</p>
						
						<ul>
							<li>
								<var>ReturnTo</var> A url to which the user is redirected after successfully authenticating
							</li>
							<li>
								<var>KeepPost</var> A boolean indicating SimpleSaml should send the post data currently available on the page back with the redirect after a successful authentication
							</li>
						</ul>
						
						<pre><code class="PHP">$as->requireAuth(
  array(
    'ReturnTo' => 'https://sp.example.org/login-success.php',
    'KeepPost' => true
  )
);</code></pre>
						<h3 id="login">Login function</h3>
						<p>While <var>requireAuth()</var> works well for webpages that are completely hidden behind an authentication wall, in some cases, it is required to only perform a login request if the user has indicated to want to login. For this, the function <var>login</var> works best. This function can be called on any page. As soon as the function is called, SimpleSaml tries authenticating the user. If the user is already signed in on another application using the same SSO, the user is automatically signed in. Otherwise, the user is redirected to the SimpleSaml login page, and redirected back to the current page after a successful authentication.</p>
						<p>The function takes the same optional parameters as <var>requireAuth()</var>, plus a few more:</p>
						<ul>
							<li><var>isPassive</var> If this is enabled, the service provider tries loging in the user automatically. This succeeds if the user is already logged in to the Identity Provider using SSO. If not, the user is redirected to the <var>ErrorURL</var>. This will not work if <var>ForceAuthn</var> is enabled in either the SP configuration, or in the arguments of this function.</li>
							<li><var>ErrorUrl</var> The URL the user is redirected to if an error occurs (such as not being able to login)</li>
							<li><var>ReturnCallback</var> A callback function that is called by SimpleSaml after the login has been performed. This has the form of a size 2 array, where the first item is an object name that is accessible from the <var>SimpleSAML_Auth_Simple</var> object (<var>saml/lib/SimpleSaml/Auth/Simple.php</var>) and the second item is a public function on that object.</li>
							<li><var>ForceAuthn</var> The opposite of <var>isPassive</var>; If this is enabled, users are always asked for their username and password when this function is called. Therefor, do not call this function with this argument set to true on the page the user is redirected to after login, unless they are not yet authenticated.</li>
						</ul>
						<pre><code class="PHP">$as->login(
  array(
    'ForceAuthn' => true,
    'KeepPost' => true,
    'isPassive' => false,
    'ReturnTo' => 'https://sp.example.org/login-success.php',
    'ErrorURL' => 'https://.../error_handler.php',
    'ReturnCallback' => array('SimpleSAML_Auth_Simple', 'callbackFunction')
  )
);</code></pre>
			<p>In addition, certain items from the service provider configuration can also be passed as an argument to the login function. See <a href="//simplesamlphp.org/docs/1.9/saml:sp" target="_blank">the SimpleSaml docs</a> for a list of configuration parameters</p><p>Some of these parameters may be used on the <var>requireAuth()</var> function as well, but this is largely a process of trial and error</p>
						<h3 id="Loginurl">Login URL</h3>
						<p>A third option is to create a link that redirects the user to the Saml login page. This function takes one optional argument, which is the return url. If no return url is set, the user is redirected to the same page as they started on after authentication.</p>
						<pre><code class="PHP">$url = $as->getLoginURL();
echo sprintf('&lt;a href="%1$s"&gt;login&lt;/a&gt;', htmlspecialchars($url));</code></pre>
						<p>An example using links for logging in and out can be found in <a href="loginOutLinks.php" target="_blank">loginOutLinks.php</a> in this repository</p>
						<h3 id="logout">Loging out</h3>
						<p>There are two ways of logging out. One is to call the <var>logout()</var> function, the other is to request the logout url from SimpleSaml, so you can provide a logout link to the user. In both cases, the <var>ReturnTo</var> should be set to the UU logout page, which handles logging out from the Identity Provider. The logout function which you can call in your project only logs the user out from the service provider. This url is <i><span class="namidp-logout-link">http://logout.uu.nl</span></i>.</p>
						<pre><code class="PHP">// Logout as soon as the page is loaded
$as->logout('<span class="namidp-logout-link">http://logout.uu.nl</span>');

// Or create a logout URL
$url = $as->getLogoutURL('<span class="namidp-logout-link">http://logout.uu.nl</span>');
echo sprintf('&lt;a href="%1$s"&gt;logout&lt;/a&gt;', htmlspecialchars($url));</code></pre>	<p>An example using links for logging in and out can be found in <a href="loginOutLinks.php" target="_blank">loginOutLinks.php</a> in this repository</p>		
						<h3 id="force auth">Force authentication</h3>
						<p>The <var>ForceAuthn</var> parameter can be especially useful to secure certain operations behind a verify login function. This can be the case if you want to make sure the user performing the action is the user that is still logged in, and not someone who noticed a web page is still left open and wants to abuse that.</p>
						<p class="alert alert-warning"><strong>Notice:</strong> The provided code depends on the <var>HTTP_REFERER</var> key in the <var>$_SERVER</var> array. This key may be absent for all kinds of reasons, so this approach may not work in all cases, e.g. when HTTP Referers are disabled in the browser. See <a href="http://stackoverflow.com/questions/6880659/in-what-cases-will-http-referer-be-empty" target="_blank">this thread from Stack Overflow</a> for a discussion.</strong></p>
						<p>Example code is provided in the file <var>verifyPasswordFunctions</var>. Comments are provided to clearify the code, but in general, what happens is this:</p>
						<ol>
							<li>Check the redirect ID passed as a get parameter with the last redirect against the last generated redirect ID from SimpleSaml. If these do not match, this suggests the user is redirected from another page with some valid post data, so the action should not be performed</li>
							<li>Check if the user that was last authenticated with SimpleSaml is the same user as the one that is currently logged in</li>
						</ol>
						<p>The main function is <var>lastLoginValid()</var>, which is passed the authentication source as an argument. The following code is an example of how this can be used in a project.</p>
						<pre><code class="PHP">if(isset($_POST['delete'])) {
 if(!$lastLoginValid($as) {
   $as->login(
     array(
       'ForceAuthn' => true,
       'KeepPost' => true,
     )
   );
 } else {
  if(isAdmin($as->getAttributes['cn'][0])) {
    // perform delete
  } else {
    // User does not have the correct rights. Abort
  }
 } else {
  // Show form where user can delete stuff
 }</code></pre>
 						<p>An example for reauthentication using SimpleSaml can be found in <a href="reAuthenticate.php" target="_blank">reAuthenticate.php</a> in this repository</p>
 						<h2 id="deviate">Deviate from the Single Sign-On</h3>
						<p>ITS envisions most applications to be only accessible for authenticated users. This works by <a href="#req-auth">requiring users to be authenticated</a> before the website loads. If a user is not yet authenticated with the Identity Provider, the user is redirected to the login page and redirected back after succesful authentication. If the user already is authenticated with the Identity Provider, but not with the Service Provider, a <i>passive authentication request</i> is sent out, unless <var>ForceAuthn</var> is enabled either in the request, or in the authentication source configuration. Similarily, in order to logout, a user should be directed to <i><span class="namidp-logout-link">http://logout.uu.nl</span></i> after logging out of the Service Provider, which means the user is not redirected back to the original application</p>
						<p>This makes sense in the scenario envisioned above, as users would otherwise be redirected back directly to a login box after logging out, but in other scenarios, it may be more useful to be redirected directly to the application. By adding the following configuration to your <var>default-sp</var> configuration in <var>config/authsources.php</var>, this can be achieved:</p>
						<pre><code class="PHP">'redirect.sign' => TRUE,
'redirect.validate' => TRUE,
'sign.authnrequest' => TRUE,
'sign.logout' => TRUE,
'validate.logout' => TRUE,</code></pre>
						<p>It is also possible to simply add<pre><code class="PHP">'ForceAuthn' => TRUE</code></pre> to this configuration, but the configuration above is more suited to deal with this. In order to explain this, it is important to understand how the SAML Single Sign-Out strategy works</p>
						<p>The Single Sign-Out strategy is an extension of the Single Sign-On strategy, which reverses the process. With a Single Sign-On request, a user is both authenticated with the Service Provider (which rests with the web application) and the Identity Provider (which actually matches login requests against a user database). In order to be logged in with the Service Provider, one has to be logged in with the Identity Provider, but this does not hold the other way around.</p>
						<p>When a logout request is generated, e.g. by means of <pre><code class="PHP">$as->logout();</code></pre> a function is called that signs the user out of the Service Provider, but not of the Identity Provider. The webpage <i><span class="namidp-logout-link">http://logout.uu.nl</span></i> handles the signout of the user from the Identity Provider, which is why this is where a user should be redirected to after a logout request from the Service Provider.</p> <p>Now imagine a user <var>A</var> signing in on a web application. An authentication request is sent to the Service Provider. With a passive request, the Service Provider requests the Identity Provider if someone is already logged in and if so, logs that user in automatically. With an <i>active</i> request, however, the Service Provider always asks the user to login manually. If user A subsequently logs out from the Service Provider, but not from the Identity Provider, and then a person B tries to authenticate, the Service Provider asks the Identity Provider to check the credentials of user B, but the Identity Provider still has a person A logged in and thus the authentication fails.</p>

						<p>The <var>ForceAuthn</var> flag ensures users have to log in, even if they are already logged in with the Identity Provider. This is therefor a good feature for verifying the identity of the currently logged in user, but not so much for disabling the Single Sign-On and Out services. The configuration given above ensures two things:</p>
						<ol>
						<li>If a user logs out, the logout request is automatically deferred to the Identity Provider as well, so if another user then logs in, no error occurs</li>
						<li>If a user is already authenticated, but is asked to verify his or her identity and the credentials entered in that box do not match those of the user that was already signed in, that original user is signed out, rather than that the new user is signed in</li>
						</ol>

							</div>
							<div id="onelogin-python3" class="tab-pane onelogin-python3 external-content" 
								role="tabpanel">
								<h2 id="setuppythonsaml" class="how-to-title">Set-up OneLogin library</h2>
<p>ITS requires all service providers to send its authentication requests over SSL. This means SAML can only be used with servers that serve the web application over secure HTTP (HTTPS).</p>

<p>These instructions try to follow the installation guide of Python3-SAML provided in the <a href="https://github.com/onelogin/python-saml" target="_blank">readme of the package</a>, but tries to help configuring the service provider exactly to the needs of ITS' identity provider</p>

<p>Do note that even for Python various implementations of SAML exist. E.g. <a href="https://github.com/rohe/pysaml2" target="_blank">PySAML2</a> or <a href="https://bitbucket.org/lgs/djangosaml2/overview" target="_blank">DjangoSaml2</a>. A library worth especially worth mentioning is <a href="https://github.com/fangli/django-saml2-auth" target="_blank">Django SAML2 Auth</a>, a library integrating the Service Provider into Django with minimal configuration required. Whether this implementation works with the IdP configuration maintained by ITS is, however, not verified, but if your current application uses Django authentication, this library might be worthwhile to explore.</p>
<p>The reason OneLogin's Python-SAML library is elaborated here is that it is a Python-general library that can be used in any Python framework, it is well documented and OneLogin has implementations for many other languages that follow roughly the same procedures. The last of these arguments means that if this how-to is succesful, it can more easily be generalized to implementations for other languages than is the case with other libraries</p>

<p>In this tutorial, the name <var>hostname</var> will be used for the base URL of the web application. The name <var>saml_location</var> will be used for the absolute path saml is installed in. The name <var>saml_url</var> will be used for the url path to the saml service provider (as <var>hostname/saml_url</var>).</p>

<ol>
<li>
	<p>Depending on which configuration you use, any of these packages may be required:</p>
	<p>
		<ul>
			<li>Linux packages:
				<ul>
					<li>libxml2</li>
					<li>libxml2-dev</li>
					<li>libxlst1-dev</li>
					<li>python-dev</li>
					<li>pkg-config</li>
					<li>libxmlsec1-dev</li>
					<li>lib-apache2-mod-wgsi (if you want to serve your python application through apache</li>
				</ul>
			</li>
			<li>Python (pip) packages:
				<ul>
				    <li>xmlsec</li>
			    	<li>isodate</li>
			    	<li>defusedxml</li>
				</ul>
			</li>
		</ul>
		</p>
	<p>If you already use Django or a similar framework, you will most likely already have these packages installed</p>
</li>
<li><p>Installing OneLogin Saml-3 is as simple as running a pip command:</p>
<p><pre><code class="sh">$ pip install python-saml</code></pre> or <pre><code class="sh">$ pip install python3-saml</code></pre>, depending on the Python version you run your application with.</p>
<p>Make sure to use the pip version corresponding to the python version (the eternal 2 vs. 3 debate) and to run the command in your virtual environment if you are using one</p><p>You may also simply add <i>python-saml</i> to your dependencies if you are using dependancy management.</p></li>

<li><p>Inside your project, create a folder named <i>saml</i>. Within this folder, you need to create two files, <i>settings.json</i> and <i>advanced_settings.json</i>, and one directory, <i>certs</i>.</p></li>
<li><p>Open the file <i>settings.json</i> you just created for editing. In the <a href="https://github.com/onelogin/python3-saml" target="_blank">readme of the python-saml repository</a> you can find complete specifications for all options in this file. However, you can use the following template as a minimal configuration. These options are at the very least required:</p>
<pre><code class="json">{
    "strict": true,
    "debug": false,
    "sp": {
        "entityId": "https://hostname/saml/metadata/",
        "assertionConsumerService": {
            "url": "https://hostname/saml/acs/",
            "binding": "urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST"
        },
        "singleLogoutService": {
            "url": "https://hostname/saml/sls/",
            "binding": "urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect"
        },
        "NameIDFormat": "urn:oasis:names:tc:SAML:2.0:nameid-format:transient"
    },
    "attributeConsumingService": { },
    "idp": {
        "entityId": "<span class="namidp-metadata-link">https://namidp.services.uu.nl/nidp/saml2/metadata</span>",
        "singleSignOnService": {
            "url": "https://<span class="idp-base-link">anamidp.services.uu.nl</span>/nidp/saml2/sso",
            "binding": "urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect"
        },
        "singleLogoutService": {
            "url": "https://<span class="idp-base-link">anamidp.services.uu.nl</span>/nidp/saml2/slo",
            "binding": "urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect"
        },
        "x509cert": ""
    }
}</code></pre>
	<ol>
		<li>Replace all occurences of <i>hostname</i> with the host name of your web application</li>
		<li>Optionally, change the value of <b>serviceName</b> and <b>serviceDescription</b> to a name and description of your liking. The name should not contain any spaces and should be as simple as possible. After you have requested access to the IdP from ITS, changing this value will cause SAML to stop working.</li>
		<li><p>If you already have the public key of the IdP you register on (either their acceptation IdP or their production IdP) you can add the contents to the value of <b>x509cert</b> inside the <b>idp</b> class of this file.</p>
		<p>If you do not have this yet, contact ITS to ask for it, or go to <a href="https://namidp.services.uu.nl/nidp/saml2/metadata" target="_blank" class="namidp-metadata-active-link">https://namidp.services.uu.nl/nidp/saml2/metadata</a> and use the value of <b>ds:X509Certificate</b> in the node <b>ds:KeyInfo</b>. You will have to remove the line endings before adding the contents of this key to your json file</p>
		<p>If that is unclear, you can always e-mail ITS and ask for the public key for their IdP (mention if you want the acceptation IdP or the production IdP)</p></li>
		<li>You can change the values of <b>strict</b> and <b>debug</b> to <i>false</i> and <i>true</i> respectively for debugging purposes, but make sure those values are as indicated above when your application runs in production status</li>
	</ol>
	<p>Do note that the <b>attributeConsumingService</b> shown in the example in the readme does not work with the IdP of ITS. Instead, you should ask ITS for access to the attributes you need. However, the value is still required in the <i>settings.json</i> file, so do not remove it.</p>
</li>

<li><p>Open the file <i>advanced_settings.json</i> you just created for editing. You can insert the following template:</p>
<pre><code class="json">{
    "security": {
        "nameIdEncrypted": false,
        "authnRequestsSigned": true,
        "logoutRequestSigned": true,
        "logoutResponseSigned": false,
        "signMetadata": false,
        "wantMessagesSigned": false,
        "wantAssertionsSigned": false,
        "wantNameId" : true,
        "wantNameIdEncrypted": false,
        "wantAssertionsEncrypted": false,
        "signatureAlgorithm": "http://www.w3.org/2000/09/xmldsig#rsa-sha1",
        "metadataValidUntil" : "2027-03-06T09:00:30Z",
        "requestedAuthnContext" : false
    },
    "contactPerson": {
        "technical": {
            "givenName": "technical_name",
            "emailAddress": "technical@example.com"
        },
        "support": {
            "givenName": "support_name",
            "emailAddress": "support@example.com"
        }
    },
    "organization": {
        "en-US": {
            "name": "default-sp",
            "displayname": "default-sp",
            "url": "https://hostname/saml"
        }
    }
}</code></pre>
	<ol>
		<li>Replace all occurences of <i>hostname</i> with the host name of your web application</li>
		<li>Replace all values in <b>ContactPerson</b> and <b>organization</b> to your own needs</li>
	</ol>
</li>

<li>
<p>Inside the <i>saml/certs</i> folder you created earlier, there should the public and private components of a key that SAML can use to sign requests.</p><p>You can use existing keys if they follow the X.509 standard (e.g. your SSL certificate), or you can generate a new private and public key. Make sure to cal them <i>sp.key</i> and <i>sp.cert</i> respectively. If you wish to generate your own keys, you can use the following command:</p>
<pre><code class="bash">$ openssl req -newkey rsa:2048 -new -x509 -days 3652 -nodes -out sp.crt -keyout sp.key</code></pre>
<p>Fill out the information that this command asks for as fits your application.</p>
<p>Once you have done this and placed them in the <i>saml/certs</i> directory, python-saml should automatically pick them up.</p>
</li>
</ol>

<h2 id="onelogin-preparing-application">Preparing your application</h2>
<p>To start using SAML in your application, you have to load the various classes. Where you do this depends on the framework you use. Minimal demos are provided by OneLogin for the <a href="https://github.com/onelogin/python3-saml/tree/master/demo-django" target="_blank">Django</a>, <a href="https://github.com/onelogin/python3-saml/tree/master/demo-flask" target="_blank">Flask</a> and <a href="https://github.com/onelogin/python3-saml/tree/master/demo_pyramid" target="_blank">Pyramid</a> frameworks. The following section largely uses examples from the django demo, but tries to elaborate a bit more on what to implement and why. The code may have been adapted to fully work with the ITS IdP.</p>
<h3 id="onelogin-auth-object">Setting up the <i>auth</i> object</h3>
<p>Python-SAML works largely from a singly object that you need in your code: the <i>auth</i> object. This object is constructed from a request (from Django, Flask, Pyramid, etc) and can be used to process the response sent by the IdP, authenticate users and extract attributes of the signed in user.</p>

<p>In order to use Python-SAML in your project, you need to load the appropriate libraries:</p>

<p><pre><code class="python">from onelogin.saml2.auth import OneLogin_Saml2_Auth
from onelogin.saml2.settings import OneLogin_Saml2_Settings
from onelogin.saml2.utils import OneLogin_Saml2_Utils
</code></pre></p>

<p>Once these libraries are loaded, the <i>auth</i> object can be constructed. This object takes two parameters: A dictionary containing request information and the full path to your saml settings directory. The latter is the location where you placed your <i>certs</i> directory and your .json files. The former has the following general form:</p>
<p><pre><code class="python">req = {
    "http_host": "",
    "script_name": "",
    "server_port": "",
    "get_data": "",
    "post_data": ""
}</code></pre></p>
<p>All these parameters are about your server. So <i>http_host</i> is your server address (in previous section indicated as <i>hostname</i>), <i>script_name</i> is the path to the specific script being executed (or page being loaded) and <i>server_port</i> is the port through which your server can be accessed. If you are using an SSL connection, this will most likely be 443.</p>
<p>In most frameworks, this dictionary can be extracted from the framework itself. E.g. in Django you would use the following function:</p>
<p><pre><code class="python">def prepare_from_django_request(request):
    return {
        'http_host': request.META['HTTP_HOST'],
        'script_name': request.META['SCRIPT_NAME'] + request.META['PATH_INFO'],
        'server_port': request.META['SERVER_PORT'],
        'get_data': request.GET.copy(),
        'post_data': request.POST.copy()
    }
</code></pre></p>
<p>How to do this for other frameworks is shown in the various demos linked earlier. In this version the value for <i>script_name</i> is slightly altered from the demo to allow your Service Provider to work on a path on your domain (e.g. <i>hostname/saml/</i> instead of directly on <i>hostname</i>). Some people might prefer pointing the service provider to a different path than the root of the domain. If, when you set <i>strict</i> to true, suddenly SAML tells you it received an invalid response, the most likely reason is that you need to account for the subdirectory SAML is located in like in the example above.</p>
<p>The auth object can be created like this:</p>
<p><pre><code class="python">auth = OneLogin_Saml2_Auth(req, custom_base_path='/path/to/saml/configuration/')</code></pre></p>
<p>You will need this auth object on any page you want to use SAML features on, so you might want to create a function that will generate this object automatically from the request object of your framework. The rest of this documentation will assume a function called <i>init_saml_auth(req)</i>, which creates the auth object from the req dictionary as indicated above. Further examples will be based on the Django framework, but an attempt will be made to generalize the code as much as possible.</p>

<h3 id="onelogin-metadata-page">Creating a Metadata page</h3>
<p>In order to have ITS add your Service Provider (SP) to their Identity Provider (IdP), they will need an overview of your metadata. This metadata is automatically generated by Python-SAML using the following code (although there are various other ways of doing this as well):</p>
<p><pre><code class="python">auth = init_saml_auth(request)
saml_settings = auth.get_settings()
metadata = saml_settings.get_sp_metadata()
errors = saml_settings.validate_metadata(metadata)
if len(errors) == 0:
    print metadata
else:
    print "Error found on Metadata: %s" % (', '.join(errors))
</code></pre></p>

<p>An XML version of this output should be located at the address set for the <b>entityID</b> which you set in the <i>settings.json</i> file. In the example, this was https://hostname/saml/metadata/</p>
<p>In Django, this view could be created as follows (notice a different method of creating the SAML settings object, using the <i>settings.SAML_FOLDER</i> parameter that refers to the <i>settings.py</i> file and should point to the full path of your saml configuration):</p>
<p><pre><code class="python">def metadata(request):
    saml_settings = OneLogin_Saml2_Settings(
    	settings=None, 
    	custom_base_path=settings.SAML_FOLDER, 
    	sp_validation_only=True
    )
    metadata = saml_settings.get_sp_metadata()
    errors = saml_settings.validate_metadata(metadata)

    if len(errors) == 0:
        resp = HttpResponse(content=metadata, content_type='text/xml')
    else:
        resp = HttpResponseServerError(content=', '.join(errors))
    return resp
</code></pre></p>

<p>Once you have done this, you can go to your metadata location (e.g. https://hostname/saml/metadata) and check if you receive any errors. If not, make sure <b>ds:X509Certificate</b> in the KeyDescriptor has a value. If so, your key files seem to be working correctly.</p>


<h2 id="onelogin-contact-ITS">Contact ITS</h2>
<p>You should now contact ITS and ask them to add your Service Provider to their Identity Provider. Save the metadata as an XML file and send this file to ITS, along with the message that you want to register your application with their Identity Provider. Give the base URL of your application and say if you want to make use of their acceptation or production Identity Provider (depending on what URL you entered in <i>settings.json</i> file).</p>
<p>Also indicate which fields you want the Identity Provider to pass back with a successful authentication redirect (such as solis-ID, full name, e-mail address, etc).</p>
<p>Once they have added you, you should be able to use SAML for authenticating your users.</p>

<h2 id="onelogin-use-in-project">Using OneLogin in your project</h2>
<h3 id="onelogin-authenticate">Authenticate users in your Python application</h3>
<p>To authenticate users, you have to send an <i>authentication request</i> to the single sign on (SSO) service of the IdP. You have already configured everything Python-SAML needs in the <i>settings.json</i> file, so the URL to send this request to can be generated from the <i>login()</i> function of the auth object. Lets say the user should be authenticated right away when they visit the index page of your site. The Django code would look like this:</p>
<p><pre><code class="python">def index(request):
    req = prepare_from_django_request(request)
    auth = init_saml_auth(req)
    url = auth.login()
    
    # Redirect the user to this url (exact method depends on framework)
    return HttpResponseRedirect(url) 
</code></pre></p>
<p>This code will redirect the user to the SAML login page configured in the IdP. If the user logs in succesfully, she will be redirected back to the Attribute Customer Service (ACS) of your service provider, where the authentication can be processed. This last redirect makes use of the POST method. The important information is encoded as POST data.</p>

<p>If you want the user to end up on a different page than your ACS page after they have authenticated, you can add the <i>return_to</i> parameter to the <i>login</i> function (in this example in your index function):</p>
<p><pre><code class="python">target_url = 'where-you-want-to-send-the-user.example.org'
auth.login(return_to=target_url)
</code></pre></p>
<p>Along with the <i>return_to</i> parameter, the login method accepts three other names parameters:
<ol><li><b>force_authn</b>: If set to <i>True</i>, the user will be forced to enter their credentials. Usually this is not required if the user is already signed in to the IdP, either on this application or on another application in the same browser.</li>
<li><s><b>is_passive</b>: This is the opposite of <i>force_authn</i>; if the user is already logged in to the IdP, the user will not have to enter their credentials, even if they did not yet log in to this specific application</s> (Not supported by the ITS IdP)</li>
<li><b>set_nameid_policy</b>: If set to true, the name ID policy will be added to the login request sent to the IdP. For the current configuration of the ITS IdP this does not add anything useful.</li>
</ol>

<h3 id='onelogin-process-response'>Process the authentication response</h3>
<p>The location of your ACS is configured in the <i>settings.json</i> file, but it still has to be implemented. In the example above, the location of the ACS is <i>https://hostname/saml/acs/</i>, so in this case, the ACS needs to be implemented on the <i>acs</i> endpoint.</p>
<p>The ACS will process the information sent back by the IdP. Lets create the acs endpoint in Django:</p>
<p><pre><code class="python">def acs(request):
    req = prepare_from_django_request(request)
    auth = init_saml_auth(req)
    auth.process_response() # This is the magic of checking the IdP response
    errors = auth.get_errors() # If something went wrong, we will know
    status = "Not authenticated"
    if len(errors) == 0:
        if auth.is_authenticated(): #this will only work on a response object
            # So we have to remember if the user already authenticated
            request.session['samlUserdata'] = auth.get_attributes()
            # We also need the NameID provided by the IdP in case we want to send a followup request
            request.session['samlNameId'] = auth.get_nameid()
            # And for good measure, let's save the session index as well
            request.session['samlSessionIndex'] = auth.get_session_index()

            if 'RelayState' in req['post_data'] and 
              OneLogin_Saml2_Utils.get_self_url(req) != req['post_data']['RelayState']:
                # If the authentication request was accompanied by a relay state, i.e. an
                # url to send the user to after authentication, redirect there
                auth.redirect_to(req['post_data']['RelayState'])
        else:
            status = "Authentication failed"
    else:
        status = str(len(errors)) + " errors: " + str(errors)

    return HttpResponse(status) # Unless a relay state was given
</code></pre></p>
<p>Notice the function call <i>is_authenticated()</i> on the auth object. This call will only work after <i>process_response()</i> is called and an actual response is available. Because this response is not stateless (i.e. no longer exists after the user navigates to a different page) this call can not always be made. To verify the authentication status of the user on later pages, the required information is stored in the session data.</p>

<p>Notice also that we extract the <i>Name ID</i> from the response object. This is because the configuration ITS has set for its IdP requires the Name ID to be sent back with every following request. This is especially important if you want to send a logout request.</p>
<p>Now that the data is stored in the session, you can use it anywhere. The various demos provided by OneLogin provide a separate page where the authenticated user can check her own attribute values.</p>
<h3 id='onelogin-check-auth-status'>Checking if the user is logged in</h3>
<p>On any page that does not have direct access to the login response, you can check if the user is logged in by checking if the key <i>samlUserdata</i> is in your session data. If you want to verify authentication on other pages in a different manner, make sure to set this up in the acs.</p>
<p>An example page to print the user attributes only if they are logged in could look like this (in Django):</p>
<p><pre><code class="python">def attributes(request):
    req = prepare_from_django_request(request)
    if 'samlUserdata' in request.session:
        lst = "&lt;ul&gt;"
        for k in request.session['samlUserdata'].keys():
            lst += "&lt;li&gt;{0}: &lt;b&gt;{1}&lt;/b&gt;&lt;/li&gt;".format(k, ', '.join(request.session['samlUserdata'][k]))
        lst += "&lt;/ul&gt;"
        lst += "&lt;a href=\"{0}\">Logout&lt;/a&gt;".format(OneLogin_Saml2_Utils.get_self_url(req) + reverse(logout))
    else:
        lst = "You are not authenticated. Login <a href=\"{0}\">here</a>".format(OneLogin_Saml2_Utils.get_self_url(req))
    return HttpResponse(lst)
</code></pre></p>
<h3 id="python-logout">Logout the user</h3>
<p>The process for a user to logout of your application consists of two parts, similar to the login: A logout request is sent to the IdP, and the IdP response is then processed on your application.</p>
<p>To send a logout request:</p>
<p><pre><code class="python">def logout(request):
    req = prepare_from_django_request(request)
    auth = init_saml_auth(req)

    # Start building the logout request
    name_id = None
    session_index = None

    # Both these parameters are required by the ITS IdP!
    if 'samlNameId' in request.session:
        name_id = request.session['samlNameId']
    if 'samlSessionIndex' in request.session:
        session_index = request.session['samlSessionIndex']

    logouturl = auth.logout(
        name_id=name_id, 
        session_index=session_index,
        return_to='<span class="namidp-logout-link" title="" data-original-title="On acceptation: http://logout.acc.uu.nl"><span class="hljs-string">http://logout.uu.nl</span></span>'
    )

    return HttpResponseRedirect(logouturl)
</code></pre></p>
When the user navigates to this endpoint, she will be redirected to the IdP with a logout request. The IdP will process this response and, if succesful, return the user to the Single Logout Service (SLS) endpoint of your SP. In the <i>settings.json</i> file we defined this as <i>https://hostname/saml/sls/</i> so in this case our SLS should be located at the <i>sls</i> endpoint:</p>
<p><pre><code class="python">def sls(request):
    req = prepare_from_django_request(request)
    auth = init_saml_auth(req)

    # create a passable function that flushes the session data.
    # At least make sure the session values you use to check if
    # your user is still authenticated are deleted, so when the
    # user goes back to your page, she has to login again
    dscb = lambda: request.session.flush()

    url = auth.process_slo(delete_session_cb=dscb)
    if url is None:
    	# If the SSO is initiated by the Service Provider, rather
    	# than by the IdP, the process_slo function does not return
    	# a url. In that case, we can extract it automatically from
    	# the auth object (if the login function was called with
    	# a 'return_to' parameter)
    	url = auth.redirect_to()
    
    errors = auth.get_errors()
    if len(errors) == 0:
        if url is not None:
            return HttpResponseRedirect(url)
        else:
            return HttpResponse("Succesfully logged out!")
    else:
    	# Construct a useful error message
    	msg = '&lt;p&gt;Logout failed&lt;/p&gt;'
        msg += '&lt;ul&gt;'
        for e in errors:
            msg += '&lt;li&gt;{0}&lt;/li&gt;'.format(e)
        msg += '&lt;/ul>'
        msg += 'Reason: {0}'.format(auth.get_last_error_reason())
        return HttpResponse(msg)

</code></pre></p>
							</div>
						</div>

						
					</div>
				</div>
			</div>
	</body>
</html>