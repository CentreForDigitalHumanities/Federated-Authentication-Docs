<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
    <meta charset="utf-8"/><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <title>PHP Guide &mdash; CDH Federated Authentication  documentation</title>
            <link rel="stylesheet" href="../_static/pygments.css" type="text/css"/>
            <link rel="stylesheet" href="../_static/theme.css" type="text/css"/>
        <script src="../_static/bootstrap.bundle.min.js"></script>
            
                    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
                    <script src="../_static/doctools.js"></script>
                    <script src="../_static/sphinx_highlight.js"></script>
            <script src="../_static/js/theme.js"></script>
            <link rel="index" title="Index" href="../genindex.html"/>
            <link rel="search" title="Search" href="../search.html"/>
            <link rel="next" title="Python guide" href="python.html"/>
            <link rel="prev" title="SAML" href="index.html"/> 
    <style>
        .navbar .caption {
            display: none;
        }
    </style>
</head>

<body>

<div class="uu-root-container">
    <div class="uu-header">
        <div class="uu-header-row">
            <div class="uu-logo">
                <img src="../_static/logo-header-en.svg">
            </div>
            <div class="fs-3 ms-5 text-black">
                CDH Federated Authentication  documentation
            </div>
            <div class="border-left ms-auto">
                <div role="search" class="ms-auto">
                  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
                    <input type="text" class="form-control" name="q" placeholder="Search docs" />
                    <input type="hidden" name="check_keywords" value="yes" />
                    <input type="hidden" name="area" value="default" />
                  </form>
                </div>
            </div>
        </div>
    </div>
        <nav class="navbar uu-navbar">
            <div class="uu-navbar-container">
                <a href="https://www.uu.nl" class="navbar-brand">
                    <img src="../_static/logo-header-en.svg">
                </a>
                <button
                    class="navbar-toggler"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#navbar-content"
                    aria-expanded="false"
                    aria-label="Toggle navigation"
                >
                    <span class="navbar-toggler-icon" />
                </button>
                <div id="navbar-content" class="collapse navbar-collapse">
                        <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../general/index.html">General information</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">SAML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developmentidp/index.html">Development IdP</a></li>
</ul>

                </div>
            </div>
        </nav>
    <div class="uu-content">
        <div class="uu-hero"><ol class="breadcrumb mb-0">
    <li class="breadcrumb-item">
        <a href="../index.html">
            CDH Federated Authentication
        </a>
    </li>
    <li class="breadcrumb-item">
        <a href="index.html"
           
               accesskey="U"
               class="active"
           >
           SAML
        </a>
    </li>
    <li class="breadcrumb-item active">PHP Guide</li>
</ol></div> 
                <div class="uu-container">
                    <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
                            <div itemprop="articleBody">
                                
  <section id="php-guide">
<h1>PHP Guide<a class="headerlink" href="#php-guide" title="Permalink to this heading">¶</a></h1>
<p>The instructions in this chapter follow the
<a class="reference external" href="https://simplesamlphp.org/docs/stable/simplesamlphp-install">SimpleSaml tutorial</a>,
but are finetuned on how to work with the Identity Provider served by ITS.</p>
<nav class="contents local" id="table-of-contents">
<p class="topic-title"><strong>Table of Contents</strong></p>
<ul class="simple">
<li><p><a class="reference internal" href="#saml-setup" id="id1">SAML Setup</a></p></li>
<li><p><a class="reference internal" href="#using-simplesaml-in-your-php-project" id="id2">Using SimpleSaml in your PHP Project</a></p>
<ul>
<li><p><a class="reference internal" href="#require-authentication" id="id3">Require Authentication</a></p></li>
<li><p><a class="reference internal" href="#login-function" id="id4">Login function</a></p></li>
<li><p><a class="reference internal" href="#login-url" id="id5">Login URL</a></p></li>
<li><p><a class="reference internal" href="#logging-out" id="id6">Logging out</a></p></li>
<li><p><a class="reference internal" href="#force-authentication" id="id7">Force authentication</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#files" id="id8">Files</a></p>
<ul>
<li><p><a class="reference internal" href="#deploy-saml-sh" id="id9">deploy_saml.sh</a></p></li>
<li><p><a class="reference internal" href="#example-authsources-php" id="id10">Example authsources.php</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="saml-setup">
<h2><a class="toc-backref" href="#id1" role="doc-backlink">SAML Setup</a><a class="headerlink" href="#saml-setup" title="Permalink to this heading">¶</a></h2>
<p>In this guide, the name <code class="docutils literal notranslate"><span class="pre">hostname</span></code> will be used for the base URL of the web
application. The name <code class="docutils literal notranslate"><span class="pre">saml_location</span></code> will be used for the absolute path
SimpleSAMLPHP is installed in. The name <code class="docutils literal notranslate"><span class="pre">saml_url</span></code> will be used for the url
path to the saml service provider (as <code class="docutils literal notranslate"><span class="pre">host/saml_url</span></code>). The name
<code class="docutils literal notranslate"><span class="pre">deploy_directory</span></code> will be used to refer to a private location on your server,
where deployment files are placed.</p>
<p>A bash script is provided at the end of this page, which will take away some
of the heavy load.</p>
<ol class="arabic">
<li><p>Download the latest SimpleSaml release from
<a class="reference external" href="https://simplesamlphp.org/download">https://simplesamlphp.org/download</a> to <code class="docutils literal notranslate"><span class="pre">deploy_dir</span></code> on your server.</p></li>
<li><p>Make sure all PHP packages mentioned in
<a class="reference external" href="https://simplesamlphp.org/docs/stable/simplesamlphp-install">section 3</a>
of the SimpleSaml docs are installed. Most of these are standard.</p></li>
<li><p>Copy the bash script <a class="reference internal" href="#deploy-saml-sh"><span class="std std-ref">deploy_saml.sh</span></a> to your <code class="docutils literal notranslate"><span class="pre">deploy_dir</span></code>, or be
prepared to perform the actions in the script manually once this how-to
indicates to run the script. In the script:</p>
<ol class="arabic simple">
<li><p>Replace the value of SAMLVersion with the version number of the
downloaded .tar.gz file. The file should be called
<code class="docutils literal notranslate"><span class="pre">simplesamlphp-&lt;version&gt;.tar.gz</span></code>. If this is not the case, the script
will fail.</p></li>
<li><p>Replace the value of <code class="docutils literal notranslate"><span class="pre">SAMLLocation</span></code> with the absolute path
<code class="docutils literal notranslate"><span class="pre">saml_location</span></code>. This should be an absolute path to a directory that is
not accessible from the web. On default DH-IT servers, this should
probably be <code class="docutils literal notranslate"><span class="pre">/hum/web/&lt;hostname&gt;/</span></code> or <code class="docutils literal notranslate"><span class="pre">/hum/web/&lt;hostname&gt;/private/</span></code>.
Make sure to end with a forward slash, or the target directory will be
overwritten.</p></li>
<li><p>Replace the value of <code class="docutils literal notranslate"><span class="pre">SAMLPubLocation</span></code> with an absolute path to where a
symlink can be created, such that <code class="docutils literal notranslate"><span class="pre">host/saml_url</span></code> opens this directory
in the browser. On default DH-IT servers, this will most likely
be <code class="docutils literal notranslate"><span class="pre">/hum/web/&lt;hostname&gt;/htdocs/&lt;saml_url&gt;</span></code></p></li>
</ol>
</li>
<li><p>Connect a private and public key to SAML. You must use keys following the
X.509 standard (e.g. your SSL certificate), provided by an UU approved CA.
Make sure to call them saml.key and saml.crt respectively. TODO: rewrite this line</p>
<ul class="simple">
<li><p>See also <a class="reference internal" href="certificates.html"><span class="doc">Generating self-signed certificates</span></a></p></li>
</ul>
</li>
<li><div class="line-block">
<div class="line">From the file <code class="docutils literal notranslate"><span class="pre">simplesaml-&lt;version&gt;.tar.gz</span></code>, copy the directories
<code class="docutils literal notranslate"><span class="pre">config</span></code> and <code class="docutils literal notranslate"><span class="pre">metadata</span></code> without changing anything to
<code class="docutils literal notranslate"><span class="pre">deploy_directory</span></code>.</div>
<div class="line"><br /></div>
<div class="line">The following minimal changes need to be made, but further configuration is
possible. For most purposes, the changes below will suffice, however.</div>
</div>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">config/config.php</span></code></p>
<ol class="arabic">
<li><p>Change the value of <code class="docutils literal notranslate"><span class="pre">baseurlpath</span></code> to <code class="docutils literal notranslate"><span class="pre">host/saml_url/</span></code> (make sure to
end with a forward slash)</p></li>
<li><p>Change <code class="docutils literal notranslate"><span class="pre">debug</span></code> and <code class="docutils literal notranslate"><span class="pre">showerrors</span></code> to false.</p></li>
<li><p>Change the value of <code class="docutils literal notranslate"><span class="pre">auth.adminpassword</span></code> to a new password. This is
the password used for the admin login on the SimpleSaml Service
Provider, so make sure to pick a safe password.</p></li>
<li><p>Set <code class="docutils literal notranslate"><span class="pre">admin.protectedindexpage</span></code> to <code class="docutils literal notranslate"><span class="pre">true</span></code></p></li>
<li><p>Change the value of <code class="docutils literal notranslate"><span class="pre">secretsalt</span></code> to a new string of sufficient length.
The best practice for generating such a salt is using the following
command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tr -c -d &#39;0123456789abcdefghijklmnopqrstuvwxyz&#39; &lt; /dev/urandom | dd bs=32 count=1 2&gt; /dev/null;echo
</pre></div>
</div>
<p>If this command complains about illegal byte sequence, first run</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ export LC_CTYPE=C
</pre></div>
</div>
</li>
<li><p>Change the value of <code class="docutils literal notranslate"><span class="pre">technicalcontact_email</span></code> to an e-mail address the
technical administrator can receive e-mails on. This e-mailaddress is
used by SimpleSaml to send error reports and this e-mail address will
be public.</p></li>
<li><div class="line-block">
<div class="line">Change <code class="docutils literal notranslate"><span class="pre">session.cookie.secure</span></code> and <code class="docutils literal notranslate"><span class="pre">session.phpsession.httponly</span></code>
to <code class="docutils literal notranslate"><span class="pre">true</span></code>.</div>
<div class="line">Optionally, update <code class="docutils literal notranslate"><span class="pre">session.cookie.path</span></code>,
<code class="docutils literal notranslate"><span class="pre">session.cookie.domain</span></code> and <code class="docutils literal notranslate"><span class="pre">session.cookie.lifetime</span></code> as explained
in the comments above those fields.</div>
</div>
</li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">login.uu.nl</span></code> and <code class="docutils literal notranslate"><span class="pre">hostname</span></code> (stripped of any https or path
specifications) to the <code class="docutils literal notranslate"><span class="pre">trusted.url.domains</span></code> array. Add other
domains you wish to redirect to after a login or logout request as well.</p></li>
</ol>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">config/authsources.php</span></code></p>
<ol class="arabic">
<li><p>In the array with the key <code class="docutils literal notranslate"><span class="pre">default-sp</span></code>, add two key-value pairs:
.. code-block:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;privatekey&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;saml.key&#39;</span><span class="p">,</span>
<span class="s1">&#39;certificate&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;saml.crt&#39;</span>
</pre></div>
</div>
<p>These keys refer to the private and public keys mentioned earlier.</p>
</li>
<li><p>Change the value of idp to the appropiate IdP:</p>
<ul class="simple">
<li><p>For acceptation: <code class="docutils literal notranslate"><span class="pre">https://login.acc.uu.nl/nidp/saml2/metadata</span></code></p></li>
<li><p>For production: <code class="docutils literal notranslate"><span class="pre">https://login.uu.nl/nidp/saml2/metadata</span></code></p></li>
</ul>
</li>
<li><p>ITS requires that a few extra security settings be enabled. Add the
following key-value pairs to the <code class="docutils literal notranslate"><span class="pre">default-sp</span></code> as above:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;redirect.sign&#39;</span> <span class="o">=&gt;</span> <span class="n">TRUE</span><span class="p">,</span>
<span class="s1">&#39;redirect.validate&#39;</span> <span class="o">=&gt;</span> <span class="n">TRUE</span><span class="p">,</span>
<span class="s1">&#39;sign.authnrequest&#39;</span> <span class="o">=&gt;</span> <span class="n">TRUE</span><span class="p">,</span>
<span class="s1">&#39;sign.logout&#39;</span> <span class="o">=&gt;</span> <span class="n">TRUE</span><span class="p">,</span>
<span class="s1">&#39;validate.logout&#39;</span> <span class="o">=&gt;</span> <span class="n">TRUE</span><span class="p">,</span>
<span class="s1">&#39;WantAssertionsSigned&#39;</span> <span class="o">=&gt;</span> <span class="n">TRUE</span><span class="p">,</span>
</pre></div>
</div>
</li>
</ol>
<p>See <a class="reference internal" href="#example-authsources-php"><span class="std std-ref">Example authsources.php</span></a> for an example</p>
</li>
</ul>
</li>
<li><p>Run the bash <code class="docutils literal notranslate"><span class="pre">deploy_saml.sh</span></code> script from the <code class="docutils literal notranslate"><span class="pre">deploy_dir</span></code>. This will
put all the files in the correct locations.</p></li>
<li><p>Open your browser and go to <code class="docutils literal notranslate"><span class="pre">host/saml_url</span></code> and login with username
admin and the password you set in <code class="docutils literal notranslate"><span class="pre">config/config.php</span></code>.</p></li>
<li><p>Click the configuration tab and check if all required parts of the PHP
installation are running. Click the sanity check link, to see if the basic
setup is configured correctly.</p></li>
<li><div class="line-block">
<div class="line">Go to the federation tab and click Show Metadata. If no errors are shown,
click the get the metadata xml on a dedicated URL link. This will download
a meta data XML file.</div>
<div class="line"><br /></div>
<div class="line">Send this file to ITS along with the message that you want to register your
application with their Identity Provider. Give the base URL of your
application and say if you want to make use of their acceptation or
production Identity Provider (depending on what URL you entered in the
<code class="docutils literal notranslate"><span class="pre">config/authsources.php</span></code> file). Also indicate which fields you want
the Identity Provider to pass back with a successful authentication
redirect (such as solis-ID, full name, e-mail address, etc).</div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Before you can connect a production SP, ITS will require you to
connect an acceptation SP first to test if it works. They’ll probably also
want a SAML trace log from a successful login/logout using the acceptation
IdP.</p>
<p>This can be done by using the SAML-tracer extension.
(<a class="reference external" href="https://addons.mozilla.org/en-US/firefox/addon/saml-tracer/">Firefox</a>,
<a class="reference external" href="https://chrome.google.com/webstore/detail/saml-tracer/mpdajninpobndbfcldcmbpnnbhibjmch?hl=en">Chrome</a>)</p>
</div>
</li>
<li><p>Wait for a reply</p></li>
<li><div class="line-block">
<div class="line">If ITS accepts the request, they will add your Service Provider to their
Identity Provider. If you’re lucky, they’ll also send you back a file
called <code class="docutils literal notranslate"><span class="pre">saml20-idp-remote.php</span></code>. This is, essentially, a PHP version of
the IdP metadata.</div>
<div class="line"><br /></div>
<div class="line">If not, you can generate this file yourself. Log into your SAML admin, go
to ‘Federation’ and click ‘XML to SimpleSAMLphp metadata converter’. Copy
the contents of their metadata
(”<a class="reference external" href="https://login(.acc).uu.nl/nidp/saml2/metadata">https://login(.acc).uu.nl/nidp/saml2/metadata</a>”) into the box, and press
parse. The contents of <code class="docutils literal notranslate"><span class="pre">saml2-idp-remote.php</span></code> should be printed on
screen. <strong>NOTE:</strong> It will also print their metadata as a SP, above the IdP
metadata. Make sure you use the configuration labeled as
<code class="docutils literal notranslate"><span class="pre">saml20-idp-remote</span></code></div>
<div class="line"><br /></div>
<div class="line">Place this file in the metadata directory inside your <code class="docutils literal notranslate"><span class="pre">deploy_dir</span></code> and
rerun the bash script <code class="docutils literal notranslate"><span class="pre">deploy_saml.sh</span></code> from your <code class="docutils literal notranslate"><span class="pre">deploy_dir</span></code>.</div>
<div class="line"><br /></div>
<div class="line">This file is unique for the Identity Provider you register your service
provider with and so does not change when you set op another service
provider on another server. Once you have this file, you can use it on
other servers as well, as long as you want to connect to the same
Identity Provider on those servers (notice that the acceptation and
production versions of the Identity Provider are two distinct Identity
Providers, so switching between those requires switching between these
files). You will, however, still need to contact ITS, as they will have
to add your Service Provider to their Identity Provider.</div>
</div>
</li>
<li><div class="line-block">
<div class="line">Go to <code class="docutils literal notranslate"><span class="pre">host/saml_url</span></code> and click the page authentication. Click test
configured authentication sources. This should redirect you to the
UU login page.</div>
<div class="line"><br /></div>
<div class="line">Enter your Solis-ID and password (or test account credentials if you
are on the acception Identity Provider and your own Solis-ID has not
been added) and click login.</div>
<div class="line"><br /></div>
<div class="line">If all works well, you are set up to implement SimpleSaml into your web
application. If you see an error, the debugging begins, which this how-to
cannot provide more than the most general pointers for. Please contact
your local (or nearest-neighbor) SAML whisperer for help if that happens.</div>
</div>
</li>
</ol>
</section>
<section id="using-simplesaml-in-your-php-project">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Using SimpleSaml in your PHP Project</a><a class="headerlink" href="#using-simplesaml-in-your-php-project" title="Permalink to this heading">¶</a></h2>
<p>Once the library is installed, SimpleSaml is relatively easy to load into your
project. The following paragraphs describe how to use functionality from
SimpleSaml in a PHP project. These functions are also documented in the
SimpleSaml docs</p>
<p>First, you have to load the library into your project, and then you have to
create a SimpleSaml authentication object for your service provider. In
this example, it is assumed the service provider is called default-sp.
This depends on how you defined your service provider in
<code class="docutils literal notranslate"><span class="pre">/config/authsources.php</span></code>.</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="c1">// Load SimpleSaml library</span>
<span class="k">require_once</span><span class="p">(</span><span class="nv">$samlloc</span> <span class="o">.</span> <span class="s2">&quot;lib/_autoload.php&quot;</span><span class="p">);</span>

<span class="c1">// Get service provider</span>
<span class="nv">$as</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SimpleSAML_Auth_Simple</span><span class="p">(</span><span class="s1">&#39;default-sp&#39;</span><span class="p">);</span>

<span class="c1">// Only get attributes if user is authenticated</span>
<span class="k">if</span><span class="p">(</span><span class="nv">$as</span><span class="o">-&gt;</span><span class="na">isAuthenticated</span><span class="p">())</span> <span class="p">{</span>
  <span class="nv">$attributes</span> <span class="o">=</span> <span class="nv">$as</span><span class="o">-&gt;</span><span class="na">getAttributes</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<section id="require-authentication">
<h3><a class="toc-backref" href="#id3" role="doc-backlink">Require Authentication</a><a class="headerlink" href="#require-authentication" title="Permalink to this heading">¶</a></h3>
<p>In most usecases ITS envisions, a website is only accessible for logged in
users. In this scenario, a user who visits the website, but is not logged in at
any of the other applications using the same Identity Provider, get redirected
to the UU Login page. After authenticating with their Solis-ID, the user gets
redirected back to the original page. As long as a user is logged in on any of
the applications using the same Identity Provider, they do not have to
reauthenticate again. This is called Single Sign-On (SSO).</p>
<p>Enabling Saml authentication on a website where no access is allowed to
unauthenticated users is very simple. On all pages where access is denied
to unauthenticated users, simply add the line</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="nv">$as</span><span class="o">-&gt;</span><span class="na">requireAuth</span><span class="p">();</span>
</pre></div>
</div>
<p>This function can take two arguments:</p>
<ul class="simple">
<li><p><em>ReturnTo</em> A url to which the user is redirected after successfully
authenticating</p></li>
<li><p><em>KeepPost</em> A boolean indicating SimpleSaml should send the post data currently
available on the page back with the redirect after a successful authentication</p></li>
</ul>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="nv">$as</span><span class="o">-&gt;</span><span class="na">requireAuth</span><span class="p">(</span>
    <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;ReturnTo&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;https://sp.example.org/login-success.php&#39;</span><span class="p">,</span>
        <span class="s1">&#39;KeepPost&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span>
    <span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
</section>
<section id="login-function">
<h3><a class="toc-backref" href="#id4" role="doc-backlink">Login function</a><a class="headerlink" href="#login-function" title="Permalink to this heading">¶</a></h3>
<p>While <code class="docutils literal notranslate"><span class="pre">requireAuth()</span></code> works well for webpages that are completely hidden
behind an authentication wall, in some cases, it is required to only perform a
login request if the user has indicated to want to login. For this, the function
<code class="docutils literal notranslate"><span class="pre">login()</span></code> works best. This function can be called on any page. As soon as the
function is called, SimpleSaml tries authenticating the user. If the user is
already signed in on another application using the same SSO, the user is
automatically signed in. Otherwise, the user is redirected to the SimpleSaml
login page, and redirected back to the current page after a successful
authentication.</p>
<p>The function takes the same optional parameters as requireAuth(), plus a few
more:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ErrorUrl</span></code> The URL the user is redirected to if an error occurs (such as not being able to login)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">isPassive</span></code> If this is enabled, the service provider tries loging in the
user automatically. This succeeds if the user is already logged in to the
Identity Provider using SSO. If not, the user is redirected to the
<code class="docutils literal notranslate"><span class="pre">ErrorURL</span></code>. This will not work if <code class="docutils literal notranslate"><span class="pre">ForceAuthn</span></code> is enabled in either the SP
configuration, or in the arguments of this function.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ReturnCallback</span></code> A callback function that is called by SimpleSaml after the
login has been performed. This has the form of a size 2 array, where the first
item is an object name that is accessible from the <code class="docutils literal notranslate"><span class="pre">SimpleSAML_Auth_Simple</span></code>
object and the second item is a public function on that object.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ForceAuthn</span></code> The opposite of isPassive; If this is enabled, users are
always asked for their username and password when this function is called.
Therefore, do not call this function with this argument set to true on the
page the user is redirected to after login, unless they are not yet
authenticated.</p></li>
</ul>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="nv">$as</span><span class="o">-&gt;</span><span class="na">login</span><span class="p">(</span>
  <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;ForceAuthn&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
    <span class="s1">&#39;KeepPost&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
    <span class="s1">&#39;isPassive&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">,</span>
    <span class="s1">&#39;ReturnTo&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;https://sp.example.org/login-success.php&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ErrorURL&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;https://.../error_handler.php&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ReturnCallback&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;SimpleSAML_Auth_Simple&#39;</span><span class="p">,</span> <span class="s1">&#39;callbackFunction&#39;</span><span class="p">)</span>
  <span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
<p>In addition, certain items from the service provider configuration can also be
passed as an argument to the login function. See the SimpleSaml docs for a
list of configuration parameters.</p>
<p>Some of these parameters may be used on the requireAuth() function as well, but
this is largely a process of trial and error.</p>
</section>
<section id="login-url">
<h3><a class="toc-backref" href="#id5" role="doc-backlink">Login URL</a><a class="headerlink" href="#login-url" title="Permalink to this heading">¶</a></h3>
<p>A third option is to create a link that redirects the user to the Saml login
page. This function takes one optional argument, which is the return url.
If no return url is set, the user is redirected to the same page as they started
on after authentication.</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="nv">$url</span> <span class="o">=</span> <span class="nv">$as</span><span class="o">-&gt;</span><span class="na">getLoginURL</span><span class="p">();</span>
<span class="k">echo</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s1">&#39;&lt;a href=&quot;%1$s&quot;&gt;login&lt;/a&gt;&#39;</span><span class="p">,</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$url</span><span class="p">));</span>
</pre></div>
</div>
</section>
<section id="logging-out">
<h3><a class="toc-backref" href="#id6" role="doc-backlink">Logging out</a><a class="headerlink" href="#logging-out" title="Permalink to this heading">¶</a></h3>
<p>There are two ways of logging out. One is to call the <code class="docutils literal notranslate"><span class="pre">logout()</span></code> function, the
other is to request the logout url from SimpleSaml, so you can provide a logout
link to the user. In both cases, the <code class="docutils literal notranslate"><span class="pre">ReturnTo</span></code> should be set to the UU logout
page, which handles logging out from the Identity Provider. The logout function
which you can call in your project only logs the user out from the service
provider. This url is <code class="docutils literal notranslate"><span class="pre">http://logout.uu.nl</span></code>.</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="c1">// Logout as soon as the page is loaded</span>
<span class="nv">$as</span><span class="o">-&gt;</span><span class="na">logout</span><span class="p">(</span><span class="s1">&#39;http://logout.uu.nl&#39;</span><span class="p">);</span>

<span class="c1">// Or create a logout URL</span>
<span class="nv">$url</span> <span class="o">=</span> <span class="nv">$as</span><span class="o">-&gt;</span><span class="na">getLogoutURL</span><span class="p">(</span><span class="s1">&#39;http://logout.uu.nl&#39;</span><span class="p">);</span>
<span class="k">echo</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s1">&#39;&lt;a href=&quot;%1$s&quot;&gt;logout&lt;/a&gt;&#39;</span><span class="p">,</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$url</span><span class="p">));</span>
</pre></div>
</div>
</section>
<section id="force-authentication">
<h3><a class="toc-backref" href="#id7" role="doc-backlink">Force authentication</a><a class="headerlink" href="#force-authentication" title="Permalink to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">ForceAuthn</span></code> parameter can be especially useful to secure certain
operations behind a verify login function. This can be the case if you want to
make sure the user performing the action is the user that is still logged in,
and not someone who noticed a web page is still left open and wants to abuse
that.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Notice: The provided code depends on the HTTP_REFERER key in the $_SERVER
array. This key may be absent for all kinds of reasons, so this approach may
not work in all cases, e.g. when HTTP Referers are disabled in the browser.
See <a class="reference external" href="http://stackoverflow.com/questions/6880659/in-what-cases-will-http-referer-be-empty">this thread from Stack Overflow</a>
for a discussion.</p>
</div>
</section>
</section>
<section id="files">
<h2><a class="toc-backref" href="#id8" role="doc-backlink">Files</a><a class="headerlink" href="#files" title="Permalink to this heading">¶</a></h2>
<section id="deploy-saml-sh">
<h3><a class="toc-backref" href="#id9" role="doc-backlink">deploy_saml.sh</a><a class="headerlink" href="#deploy-saml-sh" title="Permalink to this heading">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="nv">SAMLVersion</span><span class="o">=</span><span class="s2">&quot;1.14.11&quot;</span>
<span class="nv">SAMLLocation</span><span class="o">=</span><span class="s2">&quot;/var/www/&quot;</span>
<span class="nv">SAMLPubLocation</span><span class="o">=</span><span class="s2">&quot;/var/www/html/saml&quot;</span>
<span class="nv">webuser</span><span class="o">=</span><span class="s2">&quot;www-data&quot;</span>

<span class="c1">#### NO FURTHER CHANGES FROM HERE ######</span>
<span class="k">if</span><span class="w"> </span>!<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$USER</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$webuser</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;This script must be run as www-data&quot;</span>
<span class="w">        </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="k">fi</span>

<span class="k">if</span><span class="w"> </span>!<span class="w"> </span><span class="o">[</span><span class="w"> </span>-e<span class="w"> </span>config<span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="o">(</span>&gt;<span class="p">&amp;</span><span class="m">2</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Create a config directory first&quot;</span><span class="o">)</span>
<span class="w">        </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="k">fi</span>

<span class="k">if</span><span class="w"> </span>!<span class="w"> </span><span class="o">[</span><span class="w"> </span>-e<span class="w"> </span>metadata<span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="o">(</span>&gt;<span class="p">&amp;</span><span class="m">2</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Create a metadata directory first&quot;</span><span class="o">)</span>
<span class="w">        </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="k">fi</span>

<span class="k">if</span><span class="w"> </span>!<span class="w"> </span><span class="o">[</span><span class="w"> </span>-e<span class="w"> </span>saml.crt<span class="w"> </span>-a<span class="w"> </span>-e<span class="w"> </span>saml.pem<span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="o">(</span>&gt;<span class="p">&amp;</span><span class="m">2</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Installation failed. No keys present. Please create keys first&quot;</span><span class="o">)</span>
<span class="w">        </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="k">fi</span>

<span class="nv">SAMLName</span><span class="o">=</span>simplesamlphp-<span class="nv">$SAMLVersion</span>

tar<span class="w"> </span>xzf<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SAMLName</span><span class="si">}</span><span class="s2">.tar.gz&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>

<span class="nb">cd</span><span class="w"> </span><span class="nv">$SAMLName</span>
rm<span class="w"> </span>-r<span class="w"> </span>config<span class="w"> </span>metadata
<span class="nb">cd</span><span class="w"> </span>../

<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-e<span class="w"> </span><span class="nv">$SAMLPubLocation</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>rm<span class="w"> </span><span class="nv">$SAMLPubLocation</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Previous simlink removed&quot;</span>
<span class="k">fi</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-e<span class="w"> </span><span class="nv">$SAMLLocation$SAMLName</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>rm<span class="w"> </span>-r<span class="w"> </span><span class="nv">$SAMLLocation$SAMLName</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Previous installation removed&quot;</span>
<span class="k">fi</span>

mv<span class="w"> </span><span class="nv">$SAMLName</span><span class="w"> </span><span class="nv">$SAMLLocation</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
cp<span class="w"> </span>-r<span class="w"> </span>config<span class="w"> </span><span class="nv">$SAMLLocation</span>/<span class="nv">$SAMLName</span>/
cp<span class="w"> </span>-r<span class="w"> </span>metadata<span class="w"> </span><span class="nv">$SAMLLocation</span>/<span class="nv">$SAMLName</span>/
cp<span class="w"> </span>saml.crt<span class="w"> </span><span class="si">${</span><span class="nv">SAMLLocation</span><span class="si">}</span>/<span class="nv">$SAMLName</span>/cert/
cp<span class="w"> </span>saml.pem<span class="w"> </span><span class="si">${</span><span class="nv">SAMLLocation</span><span class="si">}</span>/<span class="nv">$SAMLName</span>/cert/

ln<span class="w"> </span>-sv<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SAMLLocation</span><span class="si">}${</span><span class="nv">SAMLName</span><span class="si">}</span><span class="s2">/www&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$SAMLPubLocation</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Copied SAML to location: </span><span class="si">${</span><span class="nv">SAMLLocation</span><span class="si">}${</span><span class="nv">SAMLName</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
</section>
<section id="example-authsources-php">
<h3><a class="toc-backref" href="#id10" role="doc-backlink">Example authsources.php</a><a class="headerlink" href="#example-authsources-php" title="Permalink to this heading">¶</a></h3>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$config</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>

  <span class="c1">// This is a authentication source which handles admin authentication.</span>
  <span class="s1">&#39;admin&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
    <span class="c1">// The default is to use core:AdminPassword, but it can be replaced with</span>
    <span class="c1">// any authentication source.</span>

    <span class="s1">&#39;core:AdminPassword&#39;</span><span class="p">,</span>
  <span class="p">),</span>


  <span class="c1">// An authentication source which can authenticate against both SAML 2.0</span>
  <span class="c1">// and Shibboleth 1.3 IdPs.</span>
  <span class="s1">&#39;default-sp&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;saml:SP&#39;</span><span class="p">,</span>
    <span class="s1">&#39;privatekey&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;saml.key&#39;</span><span class="p">,</span>
    <span class="s1">&#39;certificate&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;saml.crt&#39;</span><span class="p">,</span>

    <span class="c1">// The entity ID of this SP.</span>
    <span class="c1">// Can be NULL/unset, in which case an entity ID is generated based on the metadata URL.</span>
    <span class="s1">&#39;entityID&#39;</span> <span class="o">=&gt;</span> <span class="k">null</span><span class="p">,</span>

    <span class="s1">&#39;redirect.sign&#39;</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">,</span>
    <span class="s1">&#39;redirect.validate&#39;</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">,</span>
    <span class="s1">&#39;sign.authnrequest&#39;</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">,</span>
    <span class="s1">&#39;sign.logout&#39;</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">,</span>
    <span class="s1">&#39;validate.logout&#39;</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">,</span>
    <span class="s1">&#39;WantAssertionsSigned&#39;</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">,</span>

    <span class="s1">&#39;signature.algorithm&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;http://www.w3.org/2001/04/xmldsig-more#rsa-sha256&#39;</span><span class="p">,</span>

    <span class="c1">// The entity ID of the IdP this should SP should contact.</span>
    <span class="c1">// Can be NULL/unset, in which case the user will be shown a list of available IdPs.</span>
    <span class="s1">&#39;idp&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;https://login.uu.nl/nidp/saml2/metadata&#39;</span><span class="p">,</span>

    <span class="c1">// The URL to the discovery service.</span>
    <span class="c1">// Can be NULL/unset, in which case a builtin discovery service will be used.</span>
    <span class="s1">&#39;discoURL&#39;</span> <span class="o">=&gt;</span> <span class="k">null</span>
  <span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
</section>
</section>
</section>


                            </div>
                            </div>
                </div>
    </div>

    <footer class="uu-footer">

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Centre for Digital Humanities, Utrecht University.</p>
  </div> 

</footer>
</div>

</body>
</html>